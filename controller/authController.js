const admin = require("firebase-admin");

//---------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------- LOGIN ------------------------------------------------
//---------------------------------------------------------------------------------------------------------------------

module.exports.login = async (req, res) => {

}

//---------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------- AUTHENTICATE -----------------------------------------
//---------------------------------------------------------------------------------------------------------------------

module.exports.authenticate = (req, res, next) => {
    admin.auth().verifyIdToken(req.get('Authorization') || "", true)
        .then((decoded) => {
            return admin.auth().getUserByEmail(decoded.email)
        })
        .then((user) => {
            if (user.disabled) {
                res.json({
                    error: true,
                    msg: "User Disabled",
                    uid: user.uid,
                    email: user.email
                })
            } else {
                req.user = user.email
                req.uid = user.uid
                next();
            }
        })
        .catch((err) => {
            console.log(err);
            // res.clearCookie('_token');
            res.json({
                error: true,
                msg: "Unauthorised Access"
            });
            res.status(401);
        });
};


//---------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------- VERIFY -----------------------------------------------
//---------------------------------------------------------------------------------------------------------------------

module.exports.verify = async (req, res) => {

    res.send('ok')

};

//---------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------- LOGOUT -----------------------------------------------
//---------------------------------------------------------------------------------------------------------------------


module.exports.logout = (req, res) => {


    admin.auth().revokeRefreshTokens(req.uid)
        .then(() => {
            const metadataRef = admin.database().ref('metadata/' + req.uid);
            metadataRef.set({ revokeTime: Date.now() }).then(() => {
                console.log('Database updated successfully.');
            });
        })
        .catch((err) => {
            console.log(err)
        })

    res.send("OK");
}

